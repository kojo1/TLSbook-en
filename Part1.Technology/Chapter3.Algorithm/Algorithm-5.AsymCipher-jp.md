## 3.5 公開鍵暗号と鍵合意

### 3.5.1 背景
公開鍵暗号は、もともと暗号化と復号化に異なる鍵を使うことから片方の鍵を公開できるようにした暗号方式でした。しかし今日、公開鍵のもつ性質はさまざまな局面で応用され、その適用分野は極めて多岐にわたっています。TLSの中では、主に共通鍵の鍵配送問題の解決のための鍵交換ないし鍵合意、公開鍵署名とそれをベースにした証明書として使用されています。本章では、署名、証明書については次章以降にゆずり、公開鍵の基本的な考え方と鍵合意を中心に説明します。

RSA暗号はロナルド・リベスト、アディ・シャミア、レオナルド・エーデルマンにより発明された代表的な公開鍵暗号で、整数の素因数分解の困難性に基づいて秘匿性を実現た暗号方式です。具体的には、適切な素数の組(e, d, n)を選ぶと、下のように平文メッセージmをe乗しnを法とする剰余をとることで暗号化メッセージcを、また、cをd乗し同様に剰余をとることでもとの復号化メッセージmを得ることができます。

![3-5-0](./fig3-5-0.jpg)

しかし、この原理のままでは計算途上で巨大な整数を扱うことになります。これを削減するための多数のアルゴリズムも考案されていて、例えばモンゴメリリダクションを利用することで、...
鍵サイズの２倍の領域　


パディングOAEP, PSS

（このあたり要加筆）


### 3.5.2 RSAによる初期の鍵交換

RSAによる公開鍵暗号はTLSの初期には共通鍵暗号の鍵配送問題を解決するための鍵交換プロトコルとして広く利用されました(図3-5-1)。まず、暗号化メッセージを受け取りたい受信側は送信側に対して公開鍵を暗号化用の鍵として送付します。メッセージの送信側は受け取った公開鍵で送信メッセージを暗号化し受信側に送ります。TLSの場合、その後の共通鍵暗号によるアプリケーションメッセージの秘匿化に使用する鍵の元となるプレマスターシークレットを送ります。受け取った側はプライベート鍵のほうを利用してこれを復号化します。

<br><br>
![3-5-1](./fig3-5-1.jpg)
<br><br>

TLSの場合、サーバの成りすましを防止するためのサーバ認証も行う必要があります。上記の公開鍵の送付の際に単体の公開鍵を送るのではなくサーバ認証のためのサーバ証明書を送るようにすれば、その中に含まれている公開鍵がそのまま利用できるので好都合であると当初は考えられました。しかし、時代とともにセキュリティリスクも変化し、同じ公開鍵を長期に使い続けること(静的公開鍵)のリスクが指摘されるようになってきました(五章　安全性、脆弱性：完全前方秘匿性参照)。このリスクを回避するためには鍵ペアを頻繁に更新する必要がありますが、証明書の場合、認証局の署名を頻繁に更新するのは現実的ではありません。

またその間、暗号アルゴリズムの進歩も著しく、鍵交換に利用するアルゴリズムの選択と証明書のアルゴリズムは独立の選択基準で選択したいという要求も強くなってきて、サーバ認証のための証明書の送付と鍵交換のためのプロトコルは独立させたほうがよいという認識が強くなりました。

そのような背景で、TLS1.2の時代にはRSAの静的公開鍵による鍵交換は推奨されなくなりTLS1.3では廃止され、RSAによる公開鍵アルゴリズムは証明書用(八章 公開鍵証明書参照)に限定されるようになりました。

### 3.5.3 ディフィーヘルマン鍵交換

RSAとほぼ同時期にもう一つの公開鍵アルゴリズム、ディフィーヘルマン鍵交換(DH: Diffie–Hellman key exchange)が発明されました。このアルゴリズムは鍵交換だけに特化したアルゴリズムです(図3-5-2)。DHでは、共通の鍵値を得ようとする両者は、はじめに共通のパラメータである一組の素数(DHパラメータ)を共有しておく必要がります。このパラメータは第三者に公開することができる値です。

<br><br>
![3-5-2](./fig3-5-2.jpg)
<br><br>

鍵を交換するために、両者はそれぞれ相手や第三者に対して秘密の乱数値(秘密鍵)を生成します。この値に対して先ほどのDHパラメータを使ってべき乗の剰余を求め、その値を相手側にわたします。これは前述のRSAの公開鍵による暗号化と同じように、暗号化した値からもとの値を知ることは困難なので公開の値(DH公開鍵)として相手方に渡すことができます。

受け取った側では、この値と自分の秘密鍵、DHパラメータを使い最終的な共有鍵の値を求めます。両者の演算内容を比べてみると、単に演算の順序が異なるだけで演算の構造は同じとなっていることがわかります。このべき乗の剰余演算が可換であることは別途証明できるので、両者の秘密鍵がどのような値であってこのアルゴリズムによって共通の値を得ることが保証できます。TLSではこの値をプレマスターシークレットとして使用します。

TLSにおけるこれらのパラメータ値や公開鍵の送付方法はTLS1.2までとTLS1.3ではやや異なります。

TLS1.2までは、ClientHelloとServerHelloは使用する暗号スイートの合意のために限定され、実際にDHで使用するDHパラメータやDH公開鍵は２往復目のClientKeyExchangeとServerKeyExchangeで送られていました。TLS1.3ではハンドシェークが整理され、DHパラメータや公開鍵はClientHelloとServerHelloのKeyShare拡張に格納されるようになり、サーバはClientHelloの受信内容、クライアントはServerHelloの受信内容と自分の秘密鍵を使ってプレマスターシークレットを得て、そこからセッション鍵を導出(??章：鍵導出参照)できるようになりました。これによってTLS1.3ではハンドシェークを１往復で完了することができるようになったのとともに、ハンドシェークの途中から内容を暗号化することも可能となりました。

